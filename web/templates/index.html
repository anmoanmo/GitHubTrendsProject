<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub å…¨ç½‘çƒ­åº¦ç›‘æ§</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        body {
            background: #f4f6f9;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        .header-bg {
            background: var(--primary-gradient);
            color: white;
            padding: 60px 0 40px;
            margin-bottom: -30px;
            border-radius: 0 0 20px 20px;
        }

        .main-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            background: white;
            overflow: hidden;
        }

        .nav-pills .nav-link {
            border-radius: 30px;
            padding: 8px 25px;
            margin: 0 5px;
            color: #666;
            font-weight: 500;
            transition: all 0.3s;
        }

        .nav-pills .nav-link.active {
            background-color: #764ba2;
            color: white;
            box-shadow: 0 4px 15px rgba(118, 75, 162, 0.3);
        }

        .repo-item {
            border-left: 4px solid transparent;
            transition: background 0.2s;
        }

        .repo-item:hover {
            background-color: #f8f9fa;
            border-left-color: #764ba2;
        }

        .stat-badge {
            font-size: 0.85rem;
            padding: 5px 10px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .stat-badge.total {
            background: #eef2ff;
            color: #4f46e5;
        }

        .stat-badge.period {
            background: #ecfdf5;
            color: #10b981;
        }

        .top-one-card {
            background: var(--primary-gradient);
            color: white;
            border-radius: 15px;
            padding: 2rem;
        }

        .top-one-card a {
            color: white;
            text-decoration: none;
        }

        #chart-container {
            width: 100%;
            height: 300px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>

<body>

    <div class="loading-overlay" id="loadingMask">
        <div class="spinner-grow text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
        <h4 class="fw-light">æ­£åœ¨é€šè¿‡å…¨çƒèŠ‚ç‚¹æ‰«æ GitHub...</h4>
        <p class="text-muted small">è¿™å¯èƒ½éœ€è¦ 20-30 ç§’ï¼Œè¯·è€å¿ƒç­‰å¾…</p>
    </div>

    <header class="header-bg text-center shadow-sm">
        <div class="container">
            <h1 class="fw-bold display-5 mb-2"><i class="bi bi-github"></i> GitHub Pulse</h1>
            <p class="opacity-75 fs-5">å®æ—¶è¿½è¸ªå¼€æºé¡¹ç›®çƒ­åº¦è¶‹åŠ¿</p>
            {% if summary %}
            <div class="mt-3">
                <span class="badge bg-white text-primary bg-opacity-10 border border-white border-opacity-25 px-3 py-2">
                    <i class="bi bi-calendar-check"></i> æ•°æ®æ—¥æœŸ: {{ summary.date }}
                </span>
                <span class="badge bg-warning text-dark px-3 py-2 ms-2">
                    <i class="bi bi-clock-history"></i> æ›´æ–°äº: {{ summary.update_time }}
                </span>
            </div>
            {% endif %}
        </div>
    </header>

    <div class="container" style="margin-top: 10px;">
        <div class="d-flex justify-content-end mb-4 px-2">
            <button onclick="refreshData()" class="btn btn-light shadow-sm text-primary fw-bold rounded-pill px-4">
                <i class="bi bi-arrow-clockwise"></i> ç«‹å³æ›´æ–°å…¨ç½‘æ•°æ®
            </button>
        </div>

        {% if summary and summary.data %}
        <div class="main-card p-4">
            <ul class="nav nav-pills mb-4 justify-content-center" id="trendTabs" role="tablist">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#daily"
                        onclick="renderChart('daily')">ğŸ”¥ ä»Šæ—¥çƒ­é—¨</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#weekly"
                        onclick="renderChart('weekly')">ğŸ“… æœ¬å‘¨è¶‹åŠ¿</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#monthly"
                        onclick="renderChart('monthly')">ğŸŒ™ æœ¬æœˆç²¾é€‰</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#yearly"
                        onclick="renderChart('yearly')">ğŸ† å¹´åº¦æ¦œå•</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#all"
                        onclick="renderChart('all')">ğŸ‘‘ å†å²æ€»æ¦œ</button></li>
            </ul>

            <div class="tab-content">
                {% for period in ['daily', 'weekly', 'monthly', 'yearly', 'all'] %}
                {% set info = summary.data[period] %}
                <div class="tab-pane fade {% if period == 'daily' %}show active{% endif %}" id="{{ period }}">
                    {% if info %}
                    <div class="row g-4">
                        <div class="col-lg-4">
                            <div class="top-one-card shadow mb-4">
                                <div class="d-flex justify-content-between align-items-start">
                                    <span class="badge bg-warning text-dark mb-2">NO.1 Trending</span>
                                    <i class="bi bi-trophy-fill fs-4 text-warning"></i>
                                </div>
                                <h3 class="fw-bold text-break mb-2">
                                    <a href="{{ info.top_repo.url }}" target="_blank">{{ info.top_repo.name }}</a>
                                </h3>
                                <p class="small opacity-75 mb-4 text-truncate">{{ info.top_repo.desc }}</p>
                                <div class="d-flex justify-content-between text-white-50 small">
                                    <span><i class="bi bi-code-slash"></i> {{ info.top_repo.language }}</span>
                                    <span><i class="bi bi-star-fill"></i> {{ info.top_repo.stars_total }}</span>
                                </div>
                            </div>

                            <div class="card border-0 shadow-sm">
                                <div class="card-body">
                                    <h6 class="fw-bold text-secondary mb-3">ğŸ› ï¸ è¯­è¨€çƒ­åº¦åˆ†å¸ƒ</h6>
                                    <div id="chart-{{ period }}" style="height: 280px;"></div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-8">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-header bg-white py-3 border-0">
                                    <h5 class="mb-0 fw-bold"><i class="bi bi-list-stars text-primary"></i> æ’è¡Œæ¦œ Top 15
                                    </h5>
                                </div>
                                <div class="list-group list-group-flush">
                                    {% for repo in info.repos %}
                                    <div class="list-group-item repo-item py-3">
                                        <div class="row align-items-center">
                                            <div class="col-1 text-center text-muted fw-bold">{{ loop.index }}</div>
                                            <div class="col-md-7 col-11">
                                                <h6 class="mb-1 fw-bold">
                                                    <a href="{{ repo.url }}" target="_blank"
                                                        class="text-dark text-decoration-none hover-link">
                                                        {{ repo.name }}
                                                    </a>
                                                </h6>
                                                <small class="text-muted d-block text-truncate">{{ repo.desc }}</small>
                                                <div class="mt-1">
                                                    <span class="badge bg-light text-secondary border me-1">{{
                                                        repo.language }}</span>
                                                </div>
                                            </div>
                                            <div class="col-md-4 col-12 mt-2 mt-md-0 text-md-end">
                                                <div
                                                    class="d-flex flex-md-column flex-row gap-2 justify-content-md-end">
                                                    {% if repo.stars_period > 0 %}
                                                    <div class="stat-badge period" title="æœ¬æœŸæ–°å¢ Star">
                                                        <i class="bi bi-graph-up-arrow"></i> +{{ repo.stars_period }}
                                                    </div>
                                                    {% endif %}
                                                    <div class="stat-badge total" title="å†å²æ€» Star">
                                                        <i class="bi bi-star-fill"></i> {{ repo.stars_total }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <img src="https://cdn-icons-png.flaticon.com/512/7486/7486754.png" width="100"
                            class="mb-3 opacity-50">
                        <h5 class="text-muted">è¯¥æ—¶é—´æ®µæ•°æ®æš‚ç¼º</h5>
                        <p class="small text-secondary">è¯·ç‚¹å‡»å³ä¸Šè§’â€œç«‹å³æ›´æ–°â€æŒ‰é’®è·å–æœ€æ–°æ•°æ®</p>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>

        {% else %}
        <div class="text-center py-5 main-card">
            <h3 class="fw-light">æš‚æ— ç¼“å­˜æ•°æ®</h3>
            <p class="text-muted">è¯·ç‚¹å‡»ä¸Šæ–¹â€œç«‹å³æ›´æ–°å…¨ç½‘æ•°æ®â€åˆå§‹åŒ–ç³»ç»Ÿã€‚</p>
        </div>
        {% endif %}

        <footer class="mt-5 mb-4 text-center text-muted small">
            &copy; 2025 GitHub Trends Intelligence | Data source: GitHub Public API & Trending
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- 1. å›¾è¡¨æ¸²æŸ“é€»è¾‘ ---
        // å°†åç«¯ä¼ æ¥çš„æ•°æ®æ³¨å…¥åˆ° JS å˜é‡ä¸­
        const chartDataMap = {};
        {% if summary and summary.data %}
        {% for period, info in summary.data.items() %}
        chartDataMap['{{ period }}'] = {{ info.chart_data | tojson }};
        {% endfor %}
        {% endif %}

        function renderChart(period) {
            const chartDom = document.getElementById('chart-' + period);
            if (!chartDom || !chartDataMap[period]) return;

            // é¿å…é‡å¤åˆå§‹åŒ–
            if (echarts.getInstanceByDom(chartDom)) return;

            const myChart = echarts.init(chartDom);
            const data = chartDataMap[period];

            const option = {
                tooltip: { trigger: 'item' },
                legend: { top: '5%', left: 'center', show: false }, // éšè—å›¾ä¾‹è®©ç•Œé¢æ›´æ¸…çˆ½
                color: ['#764ba2', '#667eea', '#00cdac', '#ff9a9e', '#fbc2eb', '#fad0c4'],
                series: [
                    {
                        name: 'è¯­è¨€å æ¯”',
                        type: 'pie',
                        radius: ['40%', '70%'],
                        avoidLabelOverlap: false,
                        itemStyle: {
                            borderRadius: 10,
                            borderColor: '#fff',
                            borderWidth: 2
                        },
                        label: { show: false, position: 'center' },
                        emphasis: {
                            label: { show: true, fontSize: 16, fontWeight: 'bold' }
                        },
                        data: data
                    }
                ]
            };
            myChart.setOption(option);
        }

        // --- 2. é¡µé¢åŠ è½½åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', function () {
            // é»˜è®¤æ¸²æŸ“ç¬¬ä¸€ä¸ª active çš„ tab (daily)
            renderChart('daily');
        });

        // --- 3. æ•°æ®æ›´æ–° ---
        function refreshData() {
            if (!confirm("ç¡®å®šè¦é‡æ–°æŠ“å–å…¨ç½‘æ•°æ®å—ï¼Ÿè€—æ—¶çº¦ 20-30 ç§’ã€‚")) return;
            document.getElementById('loadingMask').style.display = 'flex';

            fetch('/run_task', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        location.reload();
                    } else {
                        alert('é”™è¯¯: ' + data.message);
                        document.getElementById('loadingMask').style.display = 'none';
                    }
                })
                .catch(err => {
                    alert('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                    document.getElementById('loadingMask').style.display = 'none';
                });
        }
    </script>
</body>

</html>