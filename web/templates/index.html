<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Trends Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root {
            --bg-body: #f8f9fa;
            --bg-card: #ffffff;
            --text-main: #2d3748;
            --text-muted: #718096;
            --border-color: #e2e8f0;
            --header-bg: linear-gradient(120deg, #667eea 0%, #764ba2 100%);
            --accent-color: #764ba2;
            --rank-bg: #edf2f7;
            --rank-color: #4a5568;
        }

        [data-theme="dark"] {
            --bg-body: #1a202c;
            --bg-card: #2d3748;
            --text-main: #e2e8f0;
            --text-muted: #a0aec0;
            --border-color: #4a5568;
            --header-bg: linear-gradient(120deg, #2c3e50 0%, #000000 100%);
            --accent-color: #a78bfa;
            --rank-bg: #4a5568;
            --rank-color: #cbd5e0;
        }

        body {
            background: var(--bg-body);
            color: var(--text-main);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            transition: all 0.3s ease;
        }

        .header-bg {
            background: var(--header-bg);
            padding: 3rem 0 5rem;
            margin-bottom: -3rem;
            border-radius: 0 0 24px 24px;
            color: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .main-card {
            background: var(--bg-card);
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .repo-item {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            padding: 1.25rem 1rem;
            transition: background 0.2s, transform 0.2s;
        }

        .repo-item:hover {
            background-color: rgba(118, 75, 162, 0.03);
            transform: translateX(4px);
        }

        .repo-item:last-child {
            border-bottom: none;
        }

        .rank-num {
            width: 28px;
            height: 28px;
            line-height: 28px;
            text-align: center;
            background: var(--rank-bg);
            color: var(--rank-color);
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.9rem;
            display: inline-block;
        }

        .repo-item:nth-child(1) .rank-num {
            background: #fee2e2;
            color: #ef4444;
        }

        .repo-item:nth-child(2) .rank-num {
            background: #ffedd5;
            color: #f97316;
        }

        .repo-item:nth-child(3) .rank-num {
            background: #fef3c7;
            color: #d97706;
        }

        .repo-link {
            color: var(--text-main);
            text-decoration: none;
            font-weight: 600;
            font-size: 1.05rem;
        }

        .repo-link:hover {
            color: var(--accent-color);
        }

        .badge-new {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            background-color: #fffbeb;
            color: #d97706;
            border: 1px solid #fcd34d;
            vertical-align: middle;
            margin-left: 6px;
        }

        [data-theme="dark"] .badge-new {
            background: #78350f;
            color: #fcd34d;
            border-color: #92400e;
        }

        .stat-group {
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: flex-end;
        }

        .stat-badge {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.85rem;
            padding: 4px 10px;
            border-radius: 8px;
            font-weight: 500;
        }

        .stat-badge.period {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .stat-badge.total {
            background: rgba(99, 102, 241, 0.1);
            color: #6366f1;
        }

        .stat-badge.total-only {
            background: var(--rank-bg);
            color: var(--text-muted);
            border: 1px solid var(--border-color);
        }

        .nav-pills .nav-link {
            color: var(--text-muted);
            border-radius: 8px;
            padding: 8px 16px;
        }

        .nav-pills .nav-link.active {
            background: var(--accent-color);
            color: white;
            box-shadow: 0 4px 6px rgba(118, 75, 162, 0.3);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            color: white;
            flex-direction: column;
            backdrop-filter: blur(5px);
        }
    </style>
</head>

<body>
    <div class="loading-overlay" id="loadingMask">
        <div class="spinner-border text-light mb-3" style="width: 3rem; height: 3rem;"></div>
        <h4>æ­£åœ¨é‡‡é›†æœ€æ–°æ•°æ®...</h4>
        <p class="opacity-75">æ™ºèƒ½åˆ†æä¸­ï¼Œå¯èƒ½éœ€è¦ 20-30 ç§’</p>
    </div>

    <header class="header-bg">
        <div class="container position-relative">
            <div class="position-absolute top-0 end-0 mt-3 me-3 fs-4" style="cursor:pointer; opacity:0.8"
                onclick="toggleTheme()">
                <i class="bi bi-moon-stars-fill" id="themeIcon"></i>
            </div>
            <div class="text-center">
                <h1 class="fw-bold mb-2"><i class="bi bi-graph-up-arrow"></i> GitHub Trends Pro</h1>
                <p class="opacity-75">å‘ç° GitHub ä¸Šçš„æ˜æ—¥ä¹‹æ˜Ÿ</p>

                <div class="d-flex justify-content-center gap-2 mt-4">
                    <select class="form-select form-select-sm w-auto shadow-none" onchange="changeDate(this.value)"
                        style="border-radius:20px; padding-left:15px;">
                        {% for date in available_dates %}
                        <option value="{{ date }}" {% if date==current_date %}selected{% endif %}>ğŸ“… {{ date }}</option>
                        {% endfor %}
                    </select>
                    <button onclick="refreshData()"
                        class="btn btn-sm btn-light rounded-pill px-3 fw-bold text-primary shadow-sm">
                        <i class="bi bi-arrow-clockwise"></i> æ›´æ–°
                    </button>
                </div>
                {% if summary %}
                <div class="mt-2 small opacity-50">Last updated: {{ summary.update_time }}</div>
                {% endif %}
            </div>
        </div>
    </header>

    <div class="container" style="margin-top: -2.5rem; position: relative; z-index: 10;">
        {% if summary and summary.data %}
        <div class="main-card p-3 p-md-4">

            <ul class="nav nav-pills mb-4 justify-content-center" id="trendTabs" role="tablist">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#daily"
                        onclick="renderChart('daily')">ä»Šæ—¥çƒ­é—¨</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#weekly"
                        onclick="renderChart('weekly')">æœ¬å‘¨è¶‹åŠ¿</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#monthly"
                        onclick="renderChart('monthly')">æœ¬æœˆç²¾é€‰</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#yearly"
                        onclick="renderChart('yearly')">å¹´åº¦æ¦œå•</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#all"
                        onclick="renderChart('all')">å†å²æ€»æ¦œ</button></li>
            </ul>

            <div class="tab-content">
                {% for period in ['daily', 'weekly', 'monthly', 'yearly', 'all'] %}
                {% set info = summary.data.get(period) %}
                <div class="tab-pane fade {% if period == 'daily' %}show active{% endif %}" id="{{ period }}">
                    {% if info %}
                    <div class="row g-4">
                        <div class="col-lg-4 order-lg-2">
                            <div class="card border-0 h-100 bg-transparent">
                                <div class="card-body px-0">
                                    <h6 class="fw-bold mb-3 small text-uppercase text-muted ls-1">è¯­è¨€åˆ†å¸ƒ</h6>
                                    <div id="chart-{{ period }}" style="height: 300px; width:100%;"></div>

                                    {% if info.top_repo %}
                                    <div class="alert mt-3 border-0 shadow-sm"
                                        style="background: rgba(118, 75, 162, 0.1); color: var(--accent-color);">
                                        <div class="d-flex align-items-center gap-2 mb-1">
                                            <span class="badge bg-warning text-dark">NO.1</span>
                                            <small class="fw-bold">æ¦œé¦–æ¨è</small>
                                        </div>
                                        <div class="fw-bold text-truncate">{{ info.top_repo.name }}</div>
                                        <div class="small opacity-75 mt-1">{{ (info.top_repo.desc or '')[:60] }}...
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-8 order-lg-1">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="fw-bold mb-0">Top Projects</h5>
                                <input type="text" class="form-control form-control-sm w-auto rounded-pill"
                                    placeholder="ğŸ” æœç´¢é¡¹ç›®..." onkeyup="filterRepos(this.value, '{{ period }}')">
                            </div>

                            <div class="list-group list-group-flush rounded-3" id="list-{{ period }}">
                                {% for repo in info.repos %}
                                <div class="repo-item d-flex flex-wrap align-items-center gap-3">
                                    <div class="rank-num">{{ loop.index }}</div>

                                    <div class="flex-grow-1" style="min-width: 200px;">
                                        <div class="d-flex align-items-center flex-wrap">
                                            <a href="{{ repo.url }}" target="_blank" class="repo-link text-break">{{
                                                repo.name }}</a>
                                            {% if repo.is_new %}
                                            <span class="badge-new" data-bs-toggle="tooltip" title="æœ€è¿‘30å¤©å†…åˆ›å»ºçš„æ–°é¡¹ç›®">âœ¨
                                                New</span>
                                            {% endif %}
                                        </div>
                                        <div class="small text-muted mt-1 text-truncate-2">{{ repo.desc }}</div>
                                        <div class="mt-2 d-flex gap-2">
                                            <span
                                                class="badge bg-secondary bg-opacity-10 text-secondary border fw-normal"
                                                style="font-size:0.75rem;">{{ repo.language }}</span>
                                        </div>
                                    </div>

                                    <div class="stat-group ms-auto">
                                        {% if repo.stars_period > 0 %}
                                        <div class="stat-badge period" data-bs-toggle="tooltip" title="æœ¬æœŸæ–°å¢ Star">
                                            <i class="bi bi-graph-up-arrow"></i> {{ repo.stars_period }}
                                        </div>
                                        {% endif %}

                                        {% if repo.stars_period > 0 %}
                                        <div class="stat-badge total" data-bs-toggle="tooltip" title="å†å²ç´¯è®¡ Star">
                                            <i class="bi bi-star-fill"></i> {{ repo.stars_total }}
                                        </div>
                                        {% else %}
                                        <div class="stat-badge total-only" data-bs-toggle="tooltip"
                                            title="ç´¯è®¡ Star (æš‚æ— å¢é‡æ•°æ®)">
                                            <i class="bi bi-star"></i> {{ repo.stars_total }}
                                        </div>
                                        {% endif %}

                                        <button class="btn btn-icon btn-sm text-muted p-1"
                                            onclick="showHistory('{{ repo.name }}')" title="æŸ¥çœ‹å†å²æ›²çº¿">
                                            <i class="bi bi-clock-history"></i>
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                                <div class="no-result text-center py-4 text-muted small" style="display:none;">æœªæ‰¾åˆ°åŒ¹é…é¡¹ç›®
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-5 opacity-50">
                        <i class="bi bi-inbox fs-1"></i>
                        <p class="mt-2">æš‚æ— æ•°æ®ï¼Œè¯·å°è¯•æ›´æ–°</p>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <div class="main-card p-5 text-center">
            <h3>ğŸ‘‹ æ¬¢è¿ä½¿ç”¨</h3>
            <p class="text-muted">æ•°æ®åº“æ­£åœ¨åˆå§‹åŒ–ï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹â€œæ›´æ–°â€æŒ‰é’®å¼€å§‹é‡‡é›†ã€‚</p>
        </div>
        {% endif %}

        <footer class="mt-5 mb-4 text-center text-muted small">
            &copy; 2025 GitHub Trends Intelligence
        </footer>
    </div>

    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold" id="modalRepoName">Repo Name</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="historyChart" style="width: 100%; height: 350px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))

        const chartDataMap = {};
        {% if summary and summary.data %}
        {% for period, info in summary.data.items() %}
        chartDataMap['{{ period }}'] = {{ info.chart_data | tojson }};
        {% endfor %}
        {% endif %}

        function renderChart(period) {
            const chartDom = document.getElementById('chart-' + period);
            if (!chartDom || !chartDataMap[period]) return;
            if (echarts.getInstanceByDom(chartDom)) return;

            const myChart = echarts.init(chartDom);
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';

            myChart.setOption({
                tooltip: { trigger: 'item' },
                series: [{
                    type: 'pie',
                    radius: ['45%', '70%'],
                    center: ['50%', '50%'],
                    itemStyle: {
                        borderRadius: 6,
                        borderColor: isDark ? '#2d3748' : '#fff',
                        borderWidth: 2
                    },
                    label: { show: false },
                    data: chartDataMap[period]
                }]
            });
        }

        const historyModal = new bootstrap.Modal(document.getElementById('historyModal'));
        let historyChartInstance = null;

        function showHistory(repoName) {
            document.getElementById('modalRepoName').innerText = repoName;
            historyModal.show();

            const chartBox = document.getElementById('historyChart');
            if (historyChartInstance) historyChartInstance.dispose();
            chartBox.innerHTML = '<div class="d-flex justify-content-center align-items-center h-100"><div class="spinner-border text-primary"></div></div>';

            fetch(`/repo_history?name=${encodeURIComponent(repoName)}`)
                .then(r => r.json())
                .then(data => {
                    chartBox.innerHTML = '';
                    if (!data.length) {
                        chartBox.innerHTML = '<p class="text-center text-muted mt-5">æš‚æ— å†å²è®°å½•</p>';
                        return;
                    }
                    historyChartInstance = echarts.init(chartBox);
                    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                    historyChartInstance.setOption({
                        grid: { top: 30, right: 20, bottom: 20, left: 50, containLabel: true },
                        tooltip: { trigger: 'axis' },
                        xAxis: { type: 'category', data: data.map(i => i.date) },
                        yAxis: { type: 'value', splitLine: { lineStyle: { color: isDark ? '#4a5568' : '#eee' } } },
                        series: [{
                            data: data.map(i => i.stars),
                            type: 'line', smooth: true,
                            itemStyle: { color: '#764ba2' },
                            areaStyle: { opacity: 0.2, color: '#764ba2' }
                        }]
                    });
                });
        }

        function filterRepos(key, period) {
            key = key.toLowerCase();
            const list = document.getElementById(`list-${period}`);
            const items = list.querySelectorAll('.repo-item');
            let found = false;
            items.forEach(el => {
                const txt = el.innerText.toLowerCase();
                if (txt.includes(key)) { el.style.display = 'flex'; found = true; }
                else { el.style.display = 'none'; }
            });
            list.querySelector('.no-result').style.display = found ? 'none' : 'block';
        }

        function toggleTheme() {
            const html = document.documentElement;
            const cur = html.getAttribute('data-theme');
            const target = cur === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', target);
            document.getElementById('themeIcon').className = target === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-stars-fill';
            localStorage.setItem('theme', target);
            const activeTab = document.querySelector('.tab-pane.show.active');
            if (activeTab) {
                const chartInst = echarts.getInstanceByDom(document.getElementById('chart-' + activeTab.id));
                if (chartInst) { chartInst.dispose(); renderChart(activeTab.id); }
            }
        }

        function changeDate(d) { window.location.href = `/?date=${d}`; }
        function refreshData() {
            if (!confirm('ç¡®å®šç«‹å³æ›´æ–°æ•°æ®ï¼Ÿ')) return;
            document.getElementById('loadingMask').style.display = 'flex';
            fetch('/run_task', { method: 'POST' }).then(r => r.json()).then(res => {
                if (res.status === 'success') location.reload();
                else { alert(res.message); document.getElementById('loadingMask').style.display = 'none'; }
            });
        }

        const saved = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', saved);
        document.getElementById('themeIcon').className = saved === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-stars-fill';
        renderChart('daily');
    </script>
</body>

</html>