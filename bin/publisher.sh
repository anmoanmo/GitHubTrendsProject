#!/bin/bash

# ========================================================
# æ¨¡å—åç§°ï¼šå¤„ç†ç»“æœå‘å¸ƒæ¨¡å— (Publisher)
# å¯¹åº”æ–‡æ¡£ï¼š(3) å¤„ç†ç»“æœå‘å¸ƒæ¨¡å— -> â€œä¿å­˜è‡³ Web æœåŠ¡å™¨ç›®å½• + ç»´æŠ¤æŒ‰æ—¥æœŸä¸‹è½½çš„é¡µé¢â€
# ========================================================

BASE_DIR=$(dirname $(dirname $(readlink -f "$0")))
DATE_STR=$(date +%F)

# è¾“å…¥æ–‡ä»¶
SUMMARY_FILE="$BASE_DIR/data/processed/summary_all_${DATE_STR}.json"

# --- å…³é”®ä¿®æ”¹ï¼šå°†å‘å¸ƒç›®å½•ç»Ÿä¸€åˆ° web/static ä¸‹ ---
# è¿™æ · Flask å¯åŠ¨åï¼Œæµè§ˆå™¨æ‰èƒ½ç›´æ¥è®¿é—®è¿™äº›æ–‡ä»¶
WEB_STATIC_DIR="$BASE_DIR/web/static"
REPORT_DIR="$WEB_STATIC_DIR/reports"
DOWNLOAD_DIR="$WEB_STATIC_DIR/downloads"

mkdir -p "$REPORT_DIR"
mkdir -p "$DOWNLOAD_DIR"

# 1. æ£€æŸ¥æ•°æ®æº
if [ ! -f "$SUMMARY_FILE" ]; then
    echo "[ERROR] æ‘˜è¦æ–‡ä»¶æœªæ‰¾åˆ°: $SUMMARY_FILE"
    exit 1
fi

# 2. æå–æ•°æ®ç”¨äºç”ŸæˆæŠ¥å‘Š
TOP_NAME=$(python3 -c "import json; d=json.load(open('$SUMMARY_FILE')); print(d.get('data',{}).get('daily',{}).get('top_repo',{}).get('name', 'N/A'))")
TOP_STARS=$(python3 -c "import json; d=json.load(open('$SUMMARY_FILE')); print(d.get('data',{}).get('daily',{}).get('top_repo',{}).get('stars_total', 0))")

# 3. å‘å¸ƒåŸå§‹æ•°æ® (æ»¡è¶³â€œæŒ‰æ—¥æœŸä¸‹è½½â€è¦æ±‚)
RAW_FILE_NAME="github_daily_${DATE_STR}.json"
# ä¼˜å…ˆæ‰¾å½“å¤©çš„åŸå§‹çˆ¬å–æ•°æ®ï¼Œæ‰¾ä¸åˆ°åˆ™ç”¨æ‘˜è¦æ•°æ®å…œåº•
if [ -f "$BASE_DIR/data/raw/$RAW_FILE_NAME" ]; then
    cp "$BASE_DIR/data/raw/$RAW_FILE_NAME" "$DOWNLOAD_DIR/"
else
    cp "$SUMMARY_FILE" "$DOWNLOAD_DIR/$RAW_FILE_NAME"
fi

# 4. ç”Ÿæˆé™æ€ HTML é¡µé¢ (æ»¡è¶³â€œWeb é¡µé¢â€è¦æ±‚)
HTML_REPORT_FILE="$REPORT_DIR/daily_report_${DATE_STR}.html"

cat > "$HTML_REPORT_FILE" <<EOF
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ—¥æŠ¥å½’æ¡£: $DATE_STR</title>
    <style>
        body { font-family: sans-serif; padding: 40px; background: #f0f2f5; }
        .card { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 600px; margin: 0 auto; }
        h1 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .stat { margin: 20px 0; font-size: 1.1em; }
        .btn { display: inline-block; background: #28a745; color: white; padding: 12px 24px; text-decoration: none; border-radius: 4px; font-weight: bold; margin-top: 20px; }
        .btn:hover { background: #218838; }
        .footer { margin-top: 30px; font-size: 0.8em; color: #666; text-align: center; }
    </style>
</head>
<body>
    <div class="card">
        <h1>ğŸ“… æ¯æ—¥è¶‹åŠ¿å½’æ¡£ ($DATE_STR)</h1>
        
        <div class="stat">
            <p>ğŸ† <strong>ä»Šæ—¥æ¦œé¦–:</strong> $TOP_NAME</p>
            <p>â­ <strong>è·å¾— Star:</strong> $TOP_STARS</p>
        </div>

        <div style="background: #e9ecef; padding: 15px; border-radius: 5px;">
            <p><strong>ğŸ“‚ æ•°æ®ä¸‹è½½ï¼š</strong></p>
            <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ä¸‹è½½ä»Šæ—¥é‡‡é›†çš„åŸå§‹æ•°æ®æ–‡ä»¶ã€‚</p>
            <a href="../../static/downloads/$RAW_FILE_NAME" class="btn" download>â¬‡ï¸ ä¸‹è½½åŸå§‹ JSON æ•°æ®</a>
        </div>

        <div class="footer">
            <p>Generated by Shell Publisher | <a href="/">è¿”å›é¦–é¡µ</a></p>
        </div>
    </div>
</body>
</html>
EOF

echo "[SUCCESS] å‘å¸ƒå®Œæˆï¼"
echo "  - é™æ€æŠ¥å‘Š: static/reports/daily_report_${DATE_STR}.html"
echo "  - ä¸‹è½½æ–‡ä»¶: static/downloads/$RAW_FILE_NAME"